
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Taller de introducción a docker">
      
      
        <meta name="author" content="Sergio Gómez <sergio@uco.es>">
      
      
      <link rel="icon" href="../images/logoasl.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.11">
    
    
      
        <title>Crear imágenes propias - Taller de Docker</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.50e68009.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754922-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
  <script async src="https://www.google-analytics.com/analytics.js"></script>


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#crear-imagenes-propias" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href=".." title="Taller de Docker" class="md-header__button md-logo" aria-label="Taller de Docker" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.6 10.59 8.38 4.8l1.69 1.7c-.24.85.15 1.78.93 2.23v5.54c-.6.34-1 .99-1 1.73a2 2 0 0 0 2 2 2 2 0 0 0 2-2c0-.74-.4-1.39-1-1.73V9.41l2.07 2.09c-.07.15-.07.32-.07.5a2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2c-.18 0-.35 0-.5.07L13.93 7.5a1.98 1.98 0 0 0-1.15-2.34c-.43-.16-.88-.2-1.28-.09L9.8 3.38l.79-.78c.78-.79 2.04-.79 2.82 0l7.99 7.99c.79.78.79 2.04 0 2.82l-7.99 7.99c-.78.79-2.04.79-2.82 0L2.6 13.41c-.79-.78-.79-2.04 0-2.82z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Taller de Docker
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Crear imágenes propias
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aulasoftwarelibre/taller-de-docker.git/" title="Ir al repositorio" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aulasoftwarelibre/taller-de-docker
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Taller de Docker" class="md-nav__button md-logo" aria-label="Taller de Docker" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.6 10.59 8.38 4.8l1.69 1.7c-.24.85.15 1.78.93 2.23v5.54c-.6.34-1 .99-1 1.73a2 2 0 0 0 2 2 2 2 0 0 0 2-2c0-.74-.4-1.39-1-1.73V9.41l2.07 2.09c-.07.15-.07.32-.07.5a2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2c-.18 0-.35 0-.5.07L13.93 7.5a1.98 1.98 0 0 0-1.15-2.34c-.43-.16-.88-.2-1.28-.09L9.8 3.38l.79-.78c.78-.79 2.04-.79 2.82 0l7.99 7.99c.79.78.79 2.04 0 2.82l-7.99 7.99c-.78.79-2.04.79-2.82 0L2.6 13.41c-.79-.78-.79-2.04 0-2.82z"/></svg>

    </a>
    Taller de Docker
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aulasoftwarelibre/taller-de-docker.git/" title="Ir al repositorio" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aulasoftwarelibre/taller-de-docker
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Taller de docker
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../introduction/" class="md-nav__link">
        Introducción
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        Instalación
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../images/" class="md-nav__link">
        Imágenes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../containers/" class="md-nav__link">
        Contenedores
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../data/" class="md-nav__link">
        Persistiendo datos
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../wordpress/" class="md-nav__link">
        Levantar un WordPress con Docker
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../docker-compose/" class="md-nav__link">
        Levantar un WordPress con Docker Compose
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Crear imágenes propias
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Crear imágenes propias
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mi-primer-dockerfile" class="md-nav__link">
    Mi primer Dockerfile
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creando-aplicaciones-en-contenedores" class="md-nav__link">
    Creando aplicaciones en contenedores
  </a>
  
    <nav class="md-nav" aria-label="Creando aplicaciones en contenedores">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#probar-nuestro-contenedor" class="md-nav__link">
    Probar nuestro contenedor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creando-la-aplicacion" class="md-nav__link">
    Creando la aplicación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#balanceo-de-carga" class="md-nav__link">
    Balanceo de carga
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compartir-imagenes" class="md-nav__link">
    Compartir imágenes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ejercicios" class="md-nav__link">
    Ejercicios:
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tips/" class="md-nav__link">
        Trucos
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mi-primer-dockerfile" class="md-nav__link">
    Mi primer Dockerfile
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creando-aplicaciones-en-contenedores" class="md-nav__link">
    Creando aplicaciones en contenedores
  </a>
  
    <nav class="md-nav" aria-label="Creando aplicaciones en contenedores">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#probar-nuestro-contenedor" class="md-nav__link">
    Probar nuestro contenedor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creando-la-aplicacion" class="md-nav__link">
    Creando la aplicación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#balanceo-de-carga" class="md-nav__link">
    Balanceo de carga
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compartir-imagenes" class="md-nav__link">
    Compartir imágenes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ejercicios" class="md-nav__link">
    Ejercicios:
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/aulasoftwarelibre/taller-de-docker.git/edit/master/docs/dockerfile.md" title="Editar esta página" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="crear-imagenes-propias">Crear imágenes propias<a class="headerlink" href="#crear-imagenes-propias" title="Permanent link">&para;</a></h1>
<p>Ya hemos visto como usar imágenes de terceros para crear aplicaciones y servicios. Pero, ¿si no hay ninguna imagen que tenga lo que queremos? ¿O si queremos hacer una imagen de nuestra aplicación para distribuirla?</p>
<p>Docker permite crear imagenes propias. Aunque podríamos hacerla partiendo de cero, es un esfuerzo que no tiene sentido. Existe ya imágenes base para crear las nuestras y es mucho más fácil crear una imagen basándose en otra que hacerlo todo nosotros.</p>
<p>Podemos partir de una imagen base que parte de un lenguaje de programación (<em>python</em>, <em>php</em>) o de alguna distribución (<em>ubuntu</em>, <em>debian</em>).</p>
<h2 id="mi-primer-dockerfile">Mi primer Dockerfile<a class="headerlink" href="#mi-primer-dockerfile" title="Permanent link">&para;</a></h2>
<p>Los <em>Dockerfile</em> son los archivos que contienen las instrucciones que crean las imagenes. Deben estar guardados dentro de un <em>build context</em>, es decir, un directorio. Este directorio es el que contiene todos los archivos necesarios para construir nuestra imagen, de ahí lo de <em>build context</em>.</p>
<p>Creamos nuestro <em>build context</em></p>
<div class="codehilite"><pre><span></span><code>mkdir -p  ~/Sites/hello-world
cd ~/Sites/hello-world
echo &quot;hello&quot; &gt; hello
</code></pre></div>

<p>Dentro de este directorio crearemos un archivo llamado <em>Dockerfile</em> con este contenido:</p>
<div class="codehilite"><pre><span></span><code>FROM busybox
COPY /hello /
RUN cat /hello
</code></pre></div>

<table>
<thead>
<tr>
<th>Directiva</th>
<th>Explicación</th>
</tr>
</thead>
<tbody>
<tr>
<td>FROM</td>
<td>Indica la imagen base sobre la que se basa esta imagen</td>
</tr>
<tr>
<td>COPY</td>
<td>Copia un archivo del <em>build context</em> y lo guarda en la imagen</td>
</tr>
<tr>
<td>RUN</td>
<td>Ejecuta el comando indicado durante el proceso de creación de imagen.</td>
</tr>
</tbody>
</table>
<p>Ahora para crear nuestra imagen usaremos <code>docker build</code>.</p>
<div class="codehilite"><pre><span></span><code>docker build -t helloapp:v1 .
</code></pre></div>

<p>El parámetro <code>-t</code> nos permite etiquetar la imagen con un nombre y una versión. El <code>.</code> indica que el <em>build context</em> es el directorio actual.</p>
<p>El resultado de ejecutar lo anterior sería:</p>
<div class="codehilite"><pre><span></span><code>$ docker build -t helloapp:v1 .
Sending build context to Docker daemon  3.072kB
Step 1/3 : FROM busybox
latest: Pulling from library/busybox
8c5a7da1afbc: Pull complete 
Digest: sha256:cb63aa0641a885f54de20f61d152187419e8f6b159ed11a251a09d115fdff9bd
Status: Downloaded newer image for busybox:latest
 ---&gt; e1ddd7948a1c
Step 2/3 : COPY /hello /
 ---&gt; 8a092965dbc9
Step 3/3 : RUN cat /hello
 ---&gt; Running in 83b5498790ca
hello
Removing intermediate container 83b5498790ca
 ---&gt; f738f117d4b6
Successfully built f738f117d4b6
Successfully tagged helloapp:v1
</code></pre></div>

<p>Y podremos ver que una nueva imagen está instalada en nuestro equipo:</p>
<div class="codehilite"><pre><span></span><code>$ docker images
REPOSITORY   TAG  IMAGE ID      CREATED         SIZE
helloapp     v1   f738f117d4b6  40 seconds ago  1.16MB
</code></pre></div>

<h2 id="creando-aplicaciones-en-contenedores">Creando aplicaciones en contenedores<a class="headerlink" href="#creando-aplicaciones-en-contenedores" title="Permanent link">&para;</a></h2>
<p>Vamos a crear un aplicación en python y la vamos a guardarla en un contenedor. Comenzamos creando un nuevo <em>build context</em>:</p>
<div class="codehilite"><pre><span></span><code>mkdir -p  ~/Sites/friendlyhello
cd ~/Sites/friendlyhello
</code></pre></div>

<p>El código de la aplicación es el siguiente, lo guardaremos en un archivo llamado <code>app.py</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">Redis</span><span class="p">,</span> <span class="n">RedisError</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="c1"># Connect to Redis</span>
<span class="n">redis</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;redis&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">socket_connect_timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">socket_timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">visits</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s2">&quot;counter&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">RedisError</span><span class="p">:</span>
        <span class="n">visits</span> <span class="o">=</span> <span class="s2">&quot;&lt;i&gt;cannot connect to Redis, counter disabled&lt;/i&gt;&quot;</span>

    <span class="n">html</span> <span class="o">=</span> <span class="s2">&quot;&lt;h3&gt;Hello </span><span class="si">{name}</span><span class="s2">!&lt;/h3&gt;&quot;</span> \
           <span class="s2">&quot;&lt;b&gt;Hostname:&lt;/b&gt; </span><span class="si">{hostname}</span><span class="s2">&lt;br/&gt;&quot;</span> \
           <span class="s2">&quot;&lt;b&gt;Visits:&lt;/b&gt; </span><span class="si">{visits}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;world&quot;</span><span class="p">),</span> <span class="n">hostname</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span>  <span class="n">visits</span><span class="o">=</span><span class="n">visits</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</code></pre></div>

<p>Nuestra aplicación tiene una serie de dependencias (librerías de terceros) que guardaremos en el archivo <em>requirements.txt</em>:</p>
<div class="codehilite"><pre><span></span><code>Flask
Redis
</code></pre></div>

<p>Y por último definimos nuestro <em>Dockerfile</em>:</p>
<div class="codehilite"><pre><span></span><code># Partimos de una base oficial de python
FROM python:2.7-slim

# El directorio de trabajo es desde donde se ejecuta el contenedor al iniciarse
WORKDIR /app

# Copiamos todos los archivos del build context al directorio /app del contenedor
COPY . /app

# Ejecutamos pip para instalar las dependencias en el contenedor
RUN pip install --trusted-host pypi.python.org -r requirements.txt

# Indicamos que este contenedor se comunica por el puerto 80/tcp
EXPOSE 80

# Declaramos una variable de entorno
ENV NAME World

# Ejecuta nuestra aplicación cuando se inicia el contenedor
CMD [&quot;python&quot;, &quot;app.py&quot;]
</code></pre></div>

<p>Para conocer todas las directivas visita la <a href="https://docs.docker.com/engine/reference/builder/">documentación oficial de Dockerfile</a>.</p>
<p>En total debemos tener 3 archivos:</p>
<div class="codehilite"><pre><span></span><code>$ ls
app.py  Dockerfile  requirements.txt
</code></pre></div>

<p>Ahora construimos la imagen de nuestra aplicación:</p>
<div class="codehilite"><pre><span></span><code>docker build -t friendlyhello .
</code></pre></div>

<p>Y comprobamos que está creada:</p>
<div class="codehilite"><pre><span></span><code>$ docker image ls
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
friendlyhello       latest              88a822b3107c        56 seconds ago      132MB
</code></pre></div>

<h3 id="probar-nuestro-contenedor">Probar nuestro contenedor<a class="headerlink" href="#probar-nuestro-contenedor" title="Permanent link">&para;</a></h3>
<p>Vamos a arrancar nuestro contenedor y probar la aplicación:</p>
<div class="codehilite"><pre><span></span><code>docker run --rm -p 4000:80 friendlyhello
</code></pre></div>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Normalmente los contenedores son de usar y tirar, sobre todo cuando hacemos pruebas. El parámetro <code>--rm</code> borra automáticamente un contenedor cuando se para. Recordemos que los datos volátiles siempre se deben guardar en volúmenes.</p>
</div>
<p>Lo que arranca la aplicación Flask:</p>
<div class="codehilite"><pre><span></span><code>$ docker run --rm -p 4000:80 friendlyhello
 * Serving Flask app &quot;app&quot; (lazy loading)
 * Environment: production
   WARNING: Do not use the development server in a production environment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)
</code></pre></div>

<p>Comprobamos en el puerto 4000 si efectivamente está iniciada o no: <a href="http://localhost:4000">http://localhost:4000</a>.</p>
<p>Obtendremos un mensaje como este:</p>
<div class="codehilite"><pre><span></span><code>Hello World!

Hostname: 0367b056e66e
Visits: cannot connect to Redis, counter disabled
</code></pre></div>

<p>Ya tenemos una imagen lista para ser usada. Pulsamos <code>Control+C</code> para interrumpir y borrar nuestro contenedor.</p>
<h3 id="creando-la-aplicacion">Creando la aplicación<a class="headerlink" href="#creando-la-aplicacion" title="Permanent link">&para;</a></h3>
<p>En este caso nuestro contenedor no funciona por sí mismo. Es muy habitual que dependamos de servicios para poder iniciar la aplicación, habitualmente bases de datos. En este caso necesitamos una base de datos <em>Redis</em> que no tenemos.</p>
<p>Como vimos en el apartado anterior, vamos a aprovechar las características de <em>Compose</em> para levantar nuestra aplicación.</p>
<p>Vamos a crear el siguiente archivo <em>docker-compose.yaml</em>:</p>
<div class="codehilite"><pre><span></span><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3&quot;</span><span class="w"></span>
<span class="nt">services</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">web</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span><span class="w"></span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;4000:80&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">redis</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"></span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;6379:6379&quot;</span><span class="w"></span>
<span class="w">        </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;./data:/data&quot;</span><span class="w"></span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis-server --appendonly yes</span><span class="w"></span>
</code></pre></div>

<p>La principal diferencia con respecto al capítulo anterior, es que en un servicio podemos indicar una imagen (parámetro <code>imagen</code>) o un <em>build context</em> (parámetro <code>build</code>). </p>
<p>Esta es una manera de integrar las dos herramientas que nos proporciona <em>Docker</em>: la creación de imágenes y la composición de aplicaciones con servicios.</p>
<h3 id="balanceo-de-carga">Balanceo de carga<a class="headerlink" href="#balanceo-de-carga" title="Permanent link">&para;</a></h3>
<p>Vamos a modificar nuestro <em>docker-compose.yaml</em>:</p>
<div class="codehilite"><pre><span></span><code>version: &quot;3&quot;
services:
    web:
        build: .
    redis:
        image: redis
        volumes:
            - &quot;./data:/data&quot;
        command: redis-server --appendonly yes
    lb:
        image: dockercloud/haproxy
        ports:
            - 4000:80
        links:
            - web
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
</code></pre></div>

<p>En este caso, el servicio web no va a tener acceso al exterior (hemos eliminado el parámetro <code>ports</code>). En su lugar hemos añadido un balanceador de carga (el servicio  <code>lb</code>).</p>
<p>Vamos a arrancar esta nueva aplicación, pero esta vez añadiendo varios servicios web:</p>
<div class="codehilite"><pre><span></span><code>docker-composer up -d --scale web=5
</code></pre></div>

<p>Esperamos a que terminen de iniciar los servicios:</p>
<div class="codehilite"><pre><span></span><code>$ docker-compose up -d --scale web=5
Creating network &quot;friendlyhello_default&quot; with the default driver
Creating friendlyhello_redis_1 ... done
Creating friendlyhello_web_1   ... done
Creating friendlyhello_web_2   ... done
Creating friendlyhello_web_3   ... done
Creating friendlyhello_web_4   ... done
Creating friendlyhello_web_5   ... done
Creating friendlyhello_lb_1    ... done
</code></pre></div>

<p>Podemos comprobar como del servicio web nos ha iniciado 5 instancias, cada uno con su sufijo numérico correspondiente. Si usamos <code>docker ps</code> para ver los contenedores disponibles tendremos:</p>
<div class="codehilite"><pre><span></span><code>$ docker ps
CONTAINER ID  IMAGE                [...]   PORTS                                    NAMES
77acae1d0567  dockercloud/haproxy  [...]   443/tcp, 1936/tcp, 0.0.0.0:4000-&gt;80/tcp  friendlyhello_lb_1
5f12fb8b80c8  friendlyhello_web    [...]   80/tcp                                   friendlyhello_web_5
fb0024591665  friendlyhello_web    [...]   80/tcp                                   friendlyhello_web_2
a20d20bdd129  friendlyhello_web    [...]   80/tcp                                   friendlyhello_web_4
53d7db212df8  friendlyhello_web    [...]   80/tcp                                   friendlyhello_web_3
41218dbbb882  friendlyhello_web    [...]   80/tcp                                   friendlyhello_web_1
06f5bf6ed070  redis                [...]   6379/tcp                                 friendlyhello_redis_1
</code></pre></div>

<p>Vamos a fijarnos en el <code>CONTAINER ID</code> y vamos a volver a abrir nuestra aplicación: <a href="http://localhost:4000">http://localhost:4000</a>.</p>
<p>Si en esta ocasión vamos recargando la página, veremos como cambian los <em>hostnames</em>, que a su vez coinciden con los identificadores de los contenedores anteriores.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Esta no es la manera adecuada de hacer balanceo de carga, puesto que todos los contenedores están en la misma máquina, lo cual no tiene sentido. Solo es una demostración. Para hacer balanceo de carga real necesitaríamos tener o emular un clustes de máquinas y crear un enjambre (<em>swarm</em>).</p>
</div>
<h2 id="compartir-imagenes">Compartir imágenes<a class="headerlink" href="#compartir-imagenes" title="Permanent link">&para;</a></h2>
<p>Si tenemos una imagen que queramos compartir, necesitamos usar un registro. Existe incluso una imagen que nos permite crear uno propio, pero vamos a usar el repositorio público de <em>Docker</em>.</p>
<p>Los pasos son:</p>
<ol>
<li>Crear una cuenta de usuario en el <a href="https://hub.docker.com">repositorio oficial de <em>Docker</em></a>.</li>
<li>Pulsar sobre el botón "<em>Create Repository +</em>".</li>
<li>
<p>En el formulario hay que rellenar solo un dato obligatoriamente: el nombre. Usaremos el de la imagen: <em>friendlyhello</em>.</p>
<p>Nuestro nombre de usuario es el namespace y es obligatorio que tenga uno. Si estuvieramos en alguna organización podríamos elegir entre varios. El resto de campos lo dejamos como está por el momento. La cuenta gratuita solo deja tener un repositorio privado, asi que no lo malgastaremos aquí.</p>
</li>
<li>
<p>Ahora tenemos que conectar nuestro cliente de <em>Docker</em> con nuestra cuenta en el <em>Hub</em>. Usamos el comando <code>docker login</code>.</p>
<div class="codehilite"><pre><span></span><code>$ docker login
Login with your Docker ID to push and pull images from Docker Hub. If you don&#39;t have a Docker ID, head over to https://hub.docker.com to create one.
Username: username
Password: ********
WARNING! Your password will be stored unencrypted in /home/sergio/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store
</code></pre></div>

<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Las claves se guardan sin cifrar. Hay que configurar un almacen de claves o recordar hacer <code>docker logout</code> para borrarla.</p>
<p>Visita <a href="https://docs.docker.com/engine/reference/commandline/login/#credentials-store">la web de referencia para saber como crear un almacen</a>.</p>
</div>
</li>
<li>
<p>Para que las imágenes se puedan guardar, tenemos que etiquetarla con el mismo nombre que tengamos en nuestro repositorio más el <em>namespace</em>. Si nuestra cuenta es '<em>username</em>' y el repositorio es '<em>friendlyhello</em>', debemos crear la imagen con la etiqueta '<em>username/friendlyhello</em>'.</p>
<div class="codehilite"><pre><span></span><code>$ docker build -t username/friendlyhello .
</code></pre></div>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Por defecto ya hemos dicho que la etiqueta si no se indica es <em>latest</em>. Podemos indicar más de una etiqueta para indicar versiones:</p>
<div class="codehilite"><pre><span></span><code>$ docker build -t username/friendlyhello -t username/friendlyhello:0.1.0 .
</code></pre></div>

<p>En la próxima que hagamos le subimos la versión en la etiqueta:</p>
<div class="codehilite"><pre><span></span><code>$ docker build -t username/friendlyhello -t username/friendlyhello:0.2.0 .
</code></pre></div>

<p>De esta manera nuestra imagen aparecerá con tres etiquetas: <em>latest</em> y <em>0.2.0</em> que serán la misma en realidad, y <em>0.1.0</em>.</p>
</div>
</li>
<li>
<p>Ahora ya podemos enviar nuestra imagen:</p>
<div class="codehilite"><pre><span></span><code>$ docker push username/friendlyhello
</code></pre></div>

</li>
</ol>
<h2 id="ejercicios">Ejercicios:<a class="headerlink" href="#ejercicios" title="Permanent link">&para;</a></h2>
<ol>
<li>Cambia el <em>docker-compose.yaml</em> para usar tu imagen en vez de hacer <em>build</em>.</li>
<li>Cambia el <em>docker-compose.yaml</em> para usar la imagen de algún compañero. </li>
</ol>

  <hr>
<div class="md-source-file">
  <small>
    
      Última actualización:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 14, 2022</span>
      
    
  </small>
</div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Pie">
      
        
        <a href="../docker-compose/" class="md-footer__link md-footer__link--prev" aria-label="Anterior: Levantar un WordPress con Docker Compose" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              Levantar un WordPress con Docker Compose
            </div>
          </div>
        </a>
      
      
        
        <a href="../tips/" class="md-footer__link md-footer__link--next" aria-label="Siguiente: Trucos" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Siguiente
              </span>
              Trucos
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyleft - CC BY-NC 4.0 - Aula de Software Libre
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant"], "translations": {"clipboard.copy": "Copiar al portapapeles", "clipboard.copied": "Copiado al portapapeles", "search.config.lang": "es", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "B\u00fasqueda", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.term.missing": "Falta", "select.version.title": "Seleccionar versi\u00f3n"}, "search": "../assets/javascripts/workers/search.092fa1f6.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.5a9542cf.min.js"></script>
      
    
  </body>
</html>